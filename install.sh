#!/bin/bash
# UnQPerp Installation Script
# Created by: Sandeep Gaddam
# Repository: UnQOfficial/UnQPerp
# Universal OS Support: Linux, macOS, Windows (WSL), Termux, FreeBSD

echo "üöÄ UnQPerp Installation Script"
echo "üìÅ Repository: UnQOfficial/UnQPerp"
echo "üåç Universal OS & Architecture Support"
echo "================================="
echo ""

# Function to detect OS and architecture
detect_system() {
    # Enhanced Termux detection with multiple methods
    if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ] || [ "$PREFIX" = "/data/data/com.termux/files/usr" ]; then
        OS="termux"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Additional Android/Termux checks
        if [[ -n "$ANDROID_ROOT" ]] || [[ -n "$PREFIX" ]] || [ -f "/system/bin/getprop" ]; then
            OS="termux"
        else
            OS="linux"
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        OS="darwin"
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
        OS="windows"
    elif [[ "$OSTYPE" == "freebsd"* ]]; then
        OS="freebsd"
    else
        # Final Android/Termux detection attempt
        if [ -d "/system/app" ] || [ -d "/data/data" ] || [ -f "/proc/version" ]; then
            if grep -q "Android" /proc/version 2>/dev/null; then
                OS="termux"
            else
                OS="unknown"
            fi
        else
            OS="unknown"
        fi
    fi

    # Detect architecture with comprehensive mapping
    ARCH=$(uname -m)
    case $ARCH in
        x86_64|amd64)
            ARCH="amd64"
            ;;
        aarch64|arm64)
            ARCH="arm64"
            ;;
        armv7l|armhf|armv7*)
            ARCH="arm"
            ;;
        i386|i686|i586)
            ARCH="386"
            ;;
        *)
            echo "‚ö†Ô∏è  Unknown architecture: $ARCH, defaulting to amd64"
            ARCH="amd64"
            ;;
    esac

    echo "üì± Detected System: $OS"
    echo "üèóÔ∏è  Detected Architecture: $ARCH"
    echo ""
}

# Function to install cloudflared
install_cloudflared() {
    local download_url=""
    local binary_name=""
    local install_path=""

    # Determine download URL and installation path based on OS and architecture
    case "$OS" in
        "linux")
            case "$ARCH" in
                "amd64") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64" ;;
                "arm64") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64" ;;
                "arm") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm" ;;
                "386") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-386" ;;
                *) echo "‚ùå Unsupported architecture: $ARCH"; return 1 ;;
            esac
            binary_name="cloudflared-linux-$ARCH"
            install_path="/usr/local/bin/cloudflared"
            ;;
        "termux")
            # Try package manager first with multiple attempts
            echo "üì¶ Trying Termux package manager..."
            if command -v pkg > /dev/null; then
                echo "üîÑ Running: pkg update && pkg install cloudflared"

                # Try updating package lists first
                if pkg update -y; then
                    echo "‚úÖ Package lists updated successfully"
                else
                    echo "‚ö†Ô∏è  Package update had issues, continuing..."
                fi

                # Try installing cloudflared
                if pkg install cloudflared -y; then
                    echo "‚úÖ Cloudflared installed via pkg!"
                    return 0
                else
                    echo "‚ö†Ô∏è  Package manager installation failed, trying manual installation..."
                fi
            else
                echo "‚ùå pkg command not found"
            fi

            # Fallback to manual installation for Termux
            case "$ARCH" in
                "arm64") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64" ;;
                "arm") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm" ;;
                "amd64") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64" ;;
                *) echo "‚ùå Unsupported Termux architecture: $ARCH"; return 1 ;;
            esac
            binary_name="cloudflared-linux-$ARCH"
            install_path="$PREFIX/bin/cloudflared"
            ;;
        "darwin")
            # Try Homebrew first
            if command -v brew > /dev/null; then
                echo "üç∫ Installing via Homebrew..."
                if brew install cloudflared; then
                    echo "‚úÖ Cloudflared installed via Homebrew!"
                    return 0
                else
                    echo "‚ö†Ô∏è  Homebrew installation failed, trying manual installation..."
                fi
            fi

            # Fallback to manual installation for macOS
            case "$ARCH" in
                "amd64") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-darwin-amd64.tgz" ;;
                "arm64") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-darwin-amd64.tgz" ;;
                *) echo "‚ùå Unsupported macOS architecture: $ARCH"; return 1 ;;
            esac
            binary_name="cloudflared"
            install_path="/usr/local/bin/cloudflared"
            ;;
        "windows")
            case "$ARCH" in
                "amd64") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" ;;
                "386") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-386.exe" ;;
                *) echo "‚ùå Unsupported Windows architecture: $ARCH"; return 1 ;;
            esac
            binary_name="cloudflared-windows-$ARCH.exe"
            install_path="/usr/local/bin/cloudflared.exe"
            ;;
        "freebsd")
            case "$ARCH" in
                "amd64") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-freebsd-amd64" ;;
                "arm64") download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-freebsd-arm64" ;;
                *) echo "‚ùå Unsupported FreeBSD architecture: $ARCH"; return 1 ;;
            esac
            binary_name="cloudflared-freebsd-$ARCH"
            install_path="/usr/local/bin/cloudflared"
            ;;
        *)
            echo "‚ùå Unsupported operating system: $OS"
            echo "üí° Please install cloudflared manually from:"
            echo "   https://github.com/cloudflare/cloudflared/releases"
            echo "üìã Choose the appropriate binary for your system:"
            echo "   - Linux x86_64: cloudflared-linux-amd64"
            echo "   - Linux ARM64: cloudflared-linux-arm64"
            echo "   - macOS: cloudflared-darwin-amd64.tgz"
            echo "   - Windows: cloudflared-windows-amd64.exe"
            return 1
            ;;
    esac

    # Download and install binary
    if [[ -n "$download_url" ]]; then
        echo "üì• Downloading cloudflared..."
        echo "üîó URL: $download_url"

        # Use appropriate download tool
        if command -v wget > /dev/null; then
            echo "üì° Using wget..."
            if ! wget -q "$download_url" -O "$binary_name"; then
                echo "‚ùå wget download failed"
                return 1
            fi
        elif command -v curl > /dev/null; then
            echo "üì° Using curl..."
            if ! curl -L -s "$download_url" -o "$binary_name"; then
                echo "‚ùå curl download failed"
                return 1
            fi
        else
            echo "‚ùå Neither wget nor curl found. Please install one of them."
            if [[ "$OS" == "termux" ]]; then
                echo "üí° Install with: pkg install wget"
            fi
            return 1
        fi

        # Verify download
        if [ ! -f "$binary_name" ] || [ ! -s "$binary_name" ]; then
            echo "‚ùå Download failed or file is empty"
            return 1
        fi

        echo "‚úÖ Download completed successfully"

        # Extract if it's a compressed file
        if [[ "$binary_name" == *.tgz ]]; then
            echo "üì¶ Extracting archive..."
            if tar -xzf "$binary_name"; then
                rm "$binary_name"
                binary_name="cloudflared"
                echo "‚úÖ Archive extracted successfully"
            else
                echo "‚ùå Failed to extract archive"
                return 1
            fi
        fi

        # Install binary to appropriate location
        echo "üîß Installing binary..."
        if [[ "$OS" == "termux" ]]; then
            # Termux installation
            if mv "$binary_name" "$install_path" && chmod +x "$install_path"; then
                echo "‚úÖ Installed to $install_path"
            else
                echo "‚ùå Failed to install to $install_path"
                return 1
            fi
        else
            # Standard Linux/Unix installation
            if command -v sudo > /dev/null; then
                if sudo mv "$binary_name" "$install_path" && sudo chmod +x "$install_path"; then
                    echo "‚úÖ Installed to $install_path"
                else
                    echo "‚ùå Failed to install to $install_path"
                    return 1
                fi
            else
                # No sudo available, install locally
                echo "‚ö†Ô∏è  No sudo available, installing to current directory"
                if chmod +x "$binary_name" && mv "$binary_name" "./cloudflared"; then
                    echo "‚úÖ Installed as ./cloudflared"
                    echo "üí° Add current directory to PATH or move cloudflared manually"
                else
                    echo "‚ùå Failed local installation"
                    return 1
                fi
            fi
        fi

        echo "üéâ Cloudflared installed successfully!"
        return 0
    else
        echo "‚ùå No download URL determined"
        return 1
    fi
}

# Check Python version and availability
echo "üêç Checking Python version..."
if command -v python3 > /dev/null; then
    PYTHON_VERSION=$(python3 --version)
    echo "‚úÖ Found: $PYTHON_VERSION"
    PYTHON_CMD="python3"
elif command -v python > /dev/null; then
    PYTHON_VERSION=$(python --version)
    echo "‚úÖ Found: $PYTHON_VERSION"
    PYTHON_CMD="python"

    # Check if it's Python 3
    if ! python -c "import sys; sys.exit(0 if sys.version_info >= (3, 7) else 1)" 2>/dev/null; then
        echo "‚ùå Python version is too old. Python 3.7+ required."
        exit 1
    fi
else
    echo "‚ùå Python is not installed. Please install Python 3.7 or higher."
    echo "üìñ Installation guides:"
    echo "   üêß Linux: sudo apt install python3 python3-pip"
    echo "   üçé macOS: brew install python3"
    echo "   üì± Termux: pkg install python"
    echo "   ü™ü Windows: Download from python.org"
    exit 1
fi

# Install Python dependencies
echo ""
echo "üì¶ Installing Python dependencies..."

# Determine appropriate pip command
if command -v pip3 > /dev/null; then
    PIP_CMD="pip3"
elif command -v pip > /dev/null; then
    PIP_CMD="pip"
else
    echo "‚ö†Ô∏è  pip not found, attempting to install..."
    if [[ "$OS" == "termux" ]]; then
        if pkg install python-pip -y; then
            echo "‚úÖ pip installed via pkg"
            PIP_CMD="pip"
        else
            echo "‚ùå Failed to install pip via pkg"
            PIP_CMD="$PYTHON_CMD -m pip"
        fi
    else
        echo "üîß Installing pip via ensurepip..."
        if $PYTHON_CMD -m ensurepip --upgrade; then
            echo "‚úÖ pip installed via ensurepip"
        else
            echo "‚ö†Ô∏è  ensurepip failed, trying alternative method"
        fi
        PIP_CMD="$PYTHON_CMD -m pip"
    fi
fi

echo "üìã Using pip command: $PIP_CMD"

# Install requirements with error handling
if $PIP_CMD install -r requirements.txt; then
    echo "‚úÖ Python dependencies installed successfully"
elif $PIP_CMD install --user -r requirements.txt; then
    echo "‚úÖ Python dependencies installed for user only"
else
    echo "‚ùå Failed to install Python dependencies"
    echo "üí° Try running manually: $PIP_CMD install --user -r requirements.txt"
    exit 1
fi

# Detect system information
detect_system

# Check if cloudflared is already installed
echo "üåê Checking Cloudflare tunnel..."
if command -v cloudflared > /dev/null; then
    CLOUDFLARED_VERSION=$(cloudflared --version 2>/dev/null | head -n1)
    echo "‚úÖ Cloudflared is already installed!"
    echo "üìã Version: $CLOUDFLARED_VERSION"
else
    echo "‚ö†Ô∏è  Cloudflared not found. Installing..."
    if install_cloudflared; then
        # Verify installation was successful
        if command -v cloudflared > /dev/null; then
            CLOUDFLARED_VERSION=$(cloudflared --version 2>/dev/null | head -n1)
            echo "üéâ Cloudflared installation verified!"
            echo "üìã Version: $CLOUDFLARED_VERSION"
        else
            echo "‚ö†Ô∏è  Cloudflared installation completed but command not found in PATH"
        fi
    else
        echo "‚ùå Cloudflared installation failed"
        echo "üí° You can still run UnQPerp and start tunnel manually:"
        echo "   1. Download cloudflared from: https://github.com/cloudflare/cloudflared/releases"
        echo "   2. Make it executable: chmod +x cloudflared"
        echo "   3. Run: ./cloudflared tunnel --url http://localhost:5000"
        echo ""
    fi
fi

echo ""
echo "üéâ UnQPerp installation completed successfully!"
echo ""
echo "üöÄ To start UnQPerp:"
echo "   $PYTHON_CMD server.py"
echo ""
echo "üåê If auto-tunnel fails, start manually:"
echo "   cloudflared tunnel --url http://localhost:5000"
echo ""
echo "üìö Read the documentation:"
echo "   üìñ README.md for project overview"  
echo "   üîß perplexity.md for AI integration guide"
echo ""
echo "üîó Repository: https://github.com/UnQOfficial/UnQPerp"
echo "üë®‚Äçüíª Created by: Sandeep Gaddam"
echo ""
echo "Happy coding with UnQPerp! ü§ñ‚ú®"

    # Detect OS and install cloudflared
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
        sudo chmod +x /usr/local/bin/cloudflared
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        brew install cloudflared
    else
        echo "‚ùå Unsupported OS. Please install cloudflared manually."
        echo "Download from: https://github.com/cloudflare/cloudflared/releases"
        exit 1
    fi
fi

echo ""
echo "‚úÖ UnQPerp installation completed successfully!"
echo ""
echo "üöÄ To start UnQPerp:"
echo "   python3 server.py"
echo ""
echo "üìö Read the documentation:"
echo "   - README.md for project overview"
echo "   - perplexity.md for AI integration guide"
echo ""
echo "üîó Repository: https://github.com/sandeepgaddam/UnQOfficial"
echo ""
echo "Happy coding with UnQPerp! ü§ñ‚ú®"
